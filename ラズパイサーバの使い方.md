# 除雪サーバの使い方

## ラズパイの起動時について

ラズパイの電源を入れると、自動的に除雪サーバが起動します。起動する除雪サーバは以下の通り。

1. 除雪サーバ
ソース：
```
sv.py
```

2. Webサーバ
ソース：
```
www/www.py
```

※実際には以下のシェル（Dosでいうところのバッチ）が起動時に実行されています。

```
run_start.sh
```

## ネットワークの構築について
ラズパイを社内のセキュリティの都合でLANに接続できない場合は、スマホのテザリングを使うと、テザリングされている機器でネットワークが組まれます。

```
[スマホ]
 |　　|
 |　　|
PC  ラズパイ
```

ノートPCからラズパイを見たい場合は、このやり方で見ることができます。

通常はHubを使うのですが、テザリングを使えば同様の事ができます。
```
[ HUB ]
 |   |
 |   |
PC  ラズパイ
```

## コントロール画面の表示について

ラズパイをネットワークに接続して、以下のURLでコントロール画面を表示することができます。

http://jyosetu.local:50100/

画面上で下図の接続ボタンを押すと、ラズパイへコマンドを送信する準備ができます。

![コマンド送信準備](https://github.com/ikuratakashi/jyosetu/raw/develop-ikura/img_md/ラズパイへのコマンド送信準備.jpg)

準備が完了すると以下のようになります。

![ラズパイへのコマンド送信可能状態](https://github.com/ikuratakashi/jyosetu/raw/develop-ikura/img_md/ラズパイへのコマンド送信可能状態.jpg)

## コントローラーの接続について

1. エレコムよりドライバをダウンロードしてインストール

https://www.elecom.co.jp/support/download/peripheral/gamepad/jcu4113s/

2. コントローラーの受信機をUSBへ挿入

3. コントローラーの動作確認

[説明書](url "https://www.elecom.co.jp/support/manual/peripheral/gamepad/jc-u4113s/jc-u4113s_v03.pdf?_gl=1*amzuf6*_gcl_au*NTkwNDQ5NTQ3LjE3MjUxMDU3MTY.*_ga*NjkwNTU3NTgzLjE3MjUxMDU3MTc.*_ga_0F81RERH28*MTcyNzA2OTI4OC4yLjEuMTcyNzA2OTQ1NC4yNS4wLjA.&_ga=2.91012060.797537133.1727069289-690557583.1725105717")

4. ゲームパッドの動作モードを設定

X Inputモードに設定します。Xboxのコントローラでの動作になります。

![X Inputモードへの切り替え](https://github.com/ikuratakashi/jyosetu/raw/develop-ikura/img_md/ゲームパッドのX_Inputモードへの設定.jpg)

5. コントローラー画面を表示してコントローラーを操作

コントローラー画面をクリックして画面を選択します。画面が選択されている場合にのみコントローラが有効になります。

コントロール画面で以下のような状態になっていれば、コマンドをラズパイに送信することができます。

![ラズパイへのコマンド送信可能状態](https://github.com/ikuratakashi/jyosetu/raw/develop-ikura/img_md/ラズパイへのコマンド送信可能状態.jpg)

### コントローラーを操作してRS232Cで送信している様子

https://youtu.be/WaNAmSU2WGg

### Windowsでコントロール画面へアクセスする際の注意点
Windowsに `Bonjour` というソフトが必要です。以下のコマンドをWindowsのコマンドラインで実行してインストールを行ってください。

```
winget install Apple.Bonjour
```

※wingetはwindowsの[ パッケージ管理ツール ](url "https://dev.classmethod.jp/articles/use_windows_package_manager_winget/")です。

## コマンドがRS232Cで送信されているか確認するには

コマンドを送信した場合は、ラズパイのACTランプ（緑）が点滅します。

https://youtube.com/shorts/WdsJGwULOZE?feature=share

クラッチのアップが定期的に送信されるため、常に点滅します。

### 送信されているコマンドを確認するには

1. RS232Cケーブルを以下のように接続

![RS232Cケーブルの接続方法](https://github.com/ikuratakashi/jyosetu/raw/develop-ikura/img_md/rs232cケーブルの接続方法.jpeg)

2. ラズパイを再起動

3. 画面左上のLXTerminalのアイコンをクリック

ターミナルが表示されます。

4. プログラムが設置してあるフォルダまで移動

```
cd jyosetu
```

5. 受信したコマンドを表示するプログラムを起動

ラズパイを起動した状態でコマンドラインを表示

```
python rs232c.py
```

RS232Cで受信したコマンドが表示されます。表示のされ方は以下の動画を参照してください。

### 3～5の手順は以下の動画を参照してください。

https://youtube.com/shorts/gknQDsaS_W8?feature=share

### プログラムの終了の仕方
ターミナル画面で、`Ctrl+C` を押すと終了します。

## 送信コマンドについて

コマンドはカンマ区切りで送信されます。

```
c_up,c_up,c_up,c_up,c_up,c_up,c_dw,c_dw,m_fw,
```

コマンドの最後は、必ずカンマ `,` が入ります。

## クラッチのダウンについて

クラッチのアップのコマンドは、クラッチのダウンを押し続けることで送信されなくなります。


クラッチのダウンを離すと、2秒ぐらいでクラッチのアップのコマンドの送信が開始されます。

## コマンドの種類

|名称|コマンド|
|------|------|
|クラッチ アップ|c_up|
|クラッチ ダウン|c_dw|
|||
|アクセル アップ|a_up|
|アクセル ダウン|a_dw|
|||
|移動 前進|m_fw|
|移動 後進|m_bk|
|移動 右|m_r|
|移動 左|m_l|
|||
|雪射出口 スティック左 左上向き|c_L_lup|
|雪射出口 スティック左 上向き|c_L_up|
|雪射出口 スティック左 右上向き|c_L_rup|
|雪射出口 スティック左 右向き|c_L_right|
|雪射出口 スティック左 右下向き|c_L_rdw|
|雪射出口 スティック左 下向き|c_L_dw|
|雪射出口 スティック左 左下向き|c_L_ldw|
|雪射出口 スティック左 左向き|c_L_left|
|||
|雪射出口 スティック右 左上向き|c_R_lup|
|雪射出口 スティック右 上向き|c_R_up|
|雪射出口 スティック右 右上向き|c_R_rup|
|雪射出口 スティック右 右向き|c_R_right|
|雪射出口 スティック右 右下向き|c_R_rdw|
|雪射出口 スティック右 下向き|c_R_dw|
|雪射出口 スティック右 左下向き|c_R_ldw|
|雪射出口 スティック右 左向き|c_R_left|
|||
|未設定ボタン△|btn_sankaku|
|未設定ボタン□|btn_sikaku|
|歯の回転のON|on|
|歯の回転のOFF|off|
|||
|緊急停止|em|

# PCからラズパイを操作する方法

Windowsであれば、VNCをインストールする事でラズパイにアクセスできます。
インストールコマンドは以下の通りです。コマンドラインで実行することでインストールされます。

```
winget install -e --id Microsoft.WindowsTerminal
```

参考：[VNCの使い方](url "https://www.indoorcorgielec.com/resources/raspberry-pi/raspberry-pi-vnc/")
